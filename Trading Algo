import yfinance as yf
import pandas as pd
import openpyxl
from openpyxl import Workbook
from datetime import datetime
import time
import numpy as np
import alpaca_trade_api as tradeapi

# Alpaca API Credentials
ALPACA_API_KEY = "ALPACA_API_KEY"
ALPACA_SECRET_KEY = "ALPACA_SECRET_KEY"
ALPACA_ENDPOINT = "ALPACA_ENDPOINT"

# Initialize Alpaca API
alpaca_api = tradeapi.REST(ALPACA_API_KEY, ALPACA_SECRET_KEY, ALPACA_ENDPOINT, api_version='v2')

# Define stock symbols
STOCK_SYMBOLS = ['AAPL', 'GOOG', 'MSFT']

# Name your Excel file and Excel sheet
EXCEL_FILE = 'Excel_File_Name.xlsx'
SHEET_NAME = 'Sheet_Name_Here'

# Trading Logic
def trading_logic(df):
    # RSI Calculation (Relative Strength Index)
    delta = df['Close'].diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(window=14).mean()
    avg_loss = loss.rolling(window=14).mean()
    rs = avg_gain / avg_loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # EMA20 Calculation (Exponential Moving Average 20 period)
    df['EMA20'] = df['Close'].ewm(span=20, adjust=False).mean()

    # Bollinger Bands Calculation (BB_Mid, BB_Upper, BB_Lower)
    df['BB_Mid'] = df['Close'].rolling(window=20).mean()
    df['BB_Upper'] = df['BB_Mid'] + 2 * df['Close'].rolling(window=20).std()
    df['BB_Lower'] = df['BB_Mid'] - 2 * df['Close'].rolling(window=20).std()

    df['Signal'] = None
    df['Action'] = None

    # Signal and Action - based on the RSI and Bollinger Bands
    for i in range(len(df)):
        if i < 20:  # This skips the first 20 rows because of rolling(window=x)
            continue

        if df['RSI'].iloc[i] < 30 and df['Close'].iloc[i] < df['BB_Lower'].iloc[i]:
            df.at[i, 'Signal'] = True
            df.at[i, 'Action'] = 'Buy'

        elif df['RSI'].iloc[i] > 70 or df['Close'].iloc[i] > df['BB_Upper'].iloc[i]:
            df.at[i, 'Signal'] = False
            df.at[i, 'Action'] = 'Sell'

    return df

# Fetch market data - This takes historical data over the last month at 15m intervals to start calculations.
def fetch_market_data(symbols, interval='15m', period='1mo'):
    data = {}
    for symbol in symbols:
        print(f"Fetching data for {symbol}...")
        stock = yf.Ticker(symbol)
        df = stock.history(period=period, interval=interval)
        df.index = pd.to_datetime(df.index)  
        df.index = df.index.tz_localize(None)  # Makes the index timezone-naive 
        data[symbol] = df
    return data

def execute_trade(symbol, action):
    try:
        # Fetches the current price
        latest_trade = alpaca_api.get_latest_trade(symbol)
        current_price = latest_trade.price

        # bracket order rules
        quantity = 1
        take_profit_price = round(current_price * 1.05, 2)  # 5% above current price
        stop_loss_price = round(current_price * 0.95, 2)    # 5% below current price

        # Submits the bracket order
        if action == 'Buy':
            print(f"Placing a bracket order (BUY) for {symbol}...")
            alpaca_api.submit_order(
                symbol=symbol,
                qty=quantity,
                side='buy',
                type='market',
                time_in_force='gtc',
                order_class='bracket',
                take_profit={'limit_price': take_profit_price},
                stop_loss={'stop_price': stop_loss_price}
            )
        elif action == 'Sell':
            print(f"Placing a bracket order (SELL) for {symbol}...")
            alpaca_api.submit_order(
                symbol=symbol,
                qty=quantity,
                side='sell',
                type='market',
                time_in_force='gtc',
                order_class='bracket',
                take_profit={'limit_price': take_profit_price},
                stop_loss={'stop_price': stop_loss_price}
            )
        else:
            print(f"No valid action for {symbol}.")
            return current_price, None, None

        # Log order details
        print(f"Ticker: {symbol} | Action: {action} | Entry Price: ${current_price:.2f} | "
              f"Take Profit: ${take_profit_price} | Stop Loss: ${stop_loss_price}")
        
        return current_price, take_profit_price, stop_loss_price

    except Exception as e:
        print(f"Error executing trade for {symbol}: {e}")
        return None, None, None

 # Load workbook or create a new one if it doesn't exist
def update_excel(data):
    try:
        wb = openpyxl.load_workbook(EXCEL_FILE)
        if SHEET_NAME in wb.sheetnames:
            sheet = wb[SHEET_NAME]
        else:
            sheet = wb.create_sheet(SHEET_NAME)
            sheet.append([  # Column headers
                'Symbol', 'Date', 'Open', 'High', 'Low', 'Close', 'Volume',
                'RSI', 'EMA20', 'BB_Mid', 'BB_Upper', 'BB_Lower', 'Signal',
                'Action', 'Entry Price', 'Take Profit', 'Stop Loss'
            ])
    except FileNotFoundError:
        print(f"Creating a new workbook {EXCEL_FILE}...")
        wb = Workbook()
        sheet = wb.active
        sheet.title = SHEET_NAME
        sheet.append([  # Column headers
            'Symbol', 'Date', 'Open', 'High', 'Low', 'Close', 'Volume',
            'RSI', 'EMA20', 'BB_Mid', 'BB_Upper', 'BB_Lower', 'Signal',
            'Action', 'Entry Price', 'Take Profit', 'Stop Loss'
        ])

    # Add data for each symbol
    for symbol, df in data.items():
        for index, row in df.iterrows():
            if isinstance(index, pd.Timestamp):
                date = index.strftime('%Y-%m-%d %H:%M:%S')
            else:
                date = str(index)

            # Core data
            open_price = row['Open']
            high = row['High']
            low = row['Low']
            close = row['Close']
            volume = row['Volume']
            rsi = row.get('RSI', np.nan)
            ema20 = row.get('EMA20', np.nan)
            bb_mid = row.get('BB_Mid', np.nan)
            bb_upper = row.get('BB_Upper', np.nan)
            bb_lower = row.get('BB_Lower', np.nan)
            signal = row.get('Signal', np.nan)
            action = row.get('Action', np.nan)

            # Bracket order details
            entry_price, take_profit_price, stop_loss_price = None, None, None
            if pd.notna(action):
                entry_price, take_profit_price, stop_loss_price = execute_trade(symbol, action)

            # Append information to Excel
            sheet.append([
                symbol, date, open_price, high, low, close, volume, rsi, ema20,
                bb_mid, bb_upper, bb_lower, signal, action, entry_price,
                take_profit_price, stop_loss_price
            ])

    # Save workbook
    wb.save(EXCEL_FILE)
    print(f"Excel file {EXCEL_FILE} updated successfully.")


# Main function
def main():
    print(f"Started at {datetime.now()}...")
    market_data = fetch_market_data(STOCK_SYMBOLS, interval='15m', period='1mo')
    for symbol, df in market_data.items():
        market_data[symbol] = advanced_trading_logic(df)
    update_excel(market_data)


# Periodic execution function
if __name__ == "__main__":
    while True:
        main()
        print("Sleeping for 15 minute...")
        time.sleep(900)
